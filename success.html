<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Payment Successful</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root{
      --bg1:#0f0f14;
      --bg2:#1a1a22;
      --accent1:#9c4ff2;
      --accent2:#225cda;
      --text:#ffffff;
      --muted: rgba(255,255,255,0.68);
      --card: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.10);
      --radius: 24px;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }

body{
  margin:0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  color: var(--text);
  background: #000000;
  padding: 40px 16px;
}

.page{
  min-height: 100vh;
  display:flex;
  flex-direction: column;
  align-items:center;
  justify-content:center;
}

    .card{
      width:100%;
      max-width: 420px;
      padding: 34px 26px;
      border-radius: var(--radius);
      background: var(--card);
      border: 1px solid var(--border);
      backdrop-filter: blur(20px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
      text-align:center;
      position: relative;
      overflow: hidden;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: var(--radius);
      background:
        radial-gradient(520px 240px at 20% 0%, rgba(156,79,242,0.18), transparent 60%),
        radial-gradient(520px 240px at 90% 110%, rgba(34,92,218,0.14), transparent 60%);
      opacity: 0.95;
      pointer-events:none;
    }

    .card > *{ position: relative; z-index: 1; }

    h2{
      margin: 14px 0 8px;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.2px;
    }

    #message{
      margin: 0;
      color: var(--muted);
      font-weight: 600;
      line-height: 1.55;
    }

    /* SUCCESS ANIMATION */
    .checkwrap{
      width: 76px;
      height: 76px;
      margin: 0 auto 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      display:flex;
      align-items:center;
      justify-content:center;
      position: relative;
      animation: popIn 520ms cubic-bezier(.2,.9,.2,1) both;
    }

    .checkwrap::after{
      content:"";
      position:absolute;
      inset:-14px;
      border-radius: 999px;
      border: 2px solid rgba(156,79,242,0.0);
      animation: ring 1.2s ease-out 180ms both;
      pointer-events:none;
    }

    .check{
      width: 42px;
      height: 42px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 18px 45px rgba(156,79,242,0.25);
      position: relative;
    }

    .check svg{
      width: 24px;
      height: 24px;
      stroke: white;
      stroke-width: 3.5;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 40;
      stroke-dashoffset: 40;
      animation: draw 620ms ease forwards 220ms;
    }

    @keyframes popIn{
      from{ transform: scale(0.72); opacity: 0; }
      to{ transform: scale(1); opacity: 1; }
    }

    @keyframes draw{
      to{ stroke-dashoffset: 0; }
    }

    @keyframes ring{
      0%{ transform: scale(0.7); opacity: 0; border-color: rgba(156,79,242,0.0); }
      25%{ opacity: 0.9; border-color: rgba(156,79,242,0.35); }
      100%{ transform: scale(1.15); opacity: 0; border-color: rgba(156,79,242,0.0); }
    }

    .btn{
      margin-top: 18px;
      width: 100%;
      padding: 16px;
      border-radius: 18px;
      border: none;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color: white;
      transition: 0.2s ease;
    }

    .btn:hover{
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(156,79,242,0.4);
    }

    .subnote{
      margin-top: 14px;
      font-size: 12px;
      color: rgba(255,255,255,0.5);
      font-weight: 600;
    }

    .codes{
      margin-top: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      align-items: stretch;
    }

    .codepill{
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 2px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 12px 14px;
      border-radius: 14px;
    }

    .copy-btn{
  margin-top: 6px;
  padding: 8px 12px;
  font-size: 13px;
  font-weight: 700;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.15);
  background: rgba(255,255,255,0.08);
  color: white;
  cursor: pointer;
  transition: 0.2s ease;
}

.copy-btn:hover{
  background: rgba(156,79,242,0.25);
  border-color: rgba(156,79,242,0.5);
}

    .appstore{
      display:inline-block;
      margin-top: 14px;
    }

.scroll-hint{
  margin-top: 18px;
  font-size: 13px;
  font-weight: 700;
  color: rgba(255,255,255,0.6);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}

.chevrons{
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.chevron{
  width: 10px;
  height: 10px;
  border-right: 2px solid white;
  border-bottom: 2px solid white;
  transform: rotate(45deg);
  opacity: 0.8;
  animation: chevronBounce 1.6s infinite;
}



@keyframes chevronBounce{
  0%,100%{ transform: translateY(0) rotate(45deg); opacity: 0.4; }
  50%{ transform: translateY(6px) rotate(45deg); opacity: 1; }
}

@keyframes bounce{
  0%,100%{ transform: translateY(0); }
  50%{ transform: translateY(6px); }
}

.how-to{
  margin-top: 32px;
  max-width: 420px;
  color: rgba(255,255,255,0.9);
  text-align: left;
}

.how-to h3{
  font-size: 16px;
  font-weight: 800;
  margin-bottom: 12px;
}

.how-to ol{
  padding-left: 18px;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.how-to li{
  font-size: 14px;
  font-weight: 600;
  color: rgba(255,255,255,0.75);
}

.video-section{
  margin-top: 40px;
  max-width: 420px;
}

    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; }
      .check svg{ stroke-dashoffset: 0; }
    }
  </style>
</head>

<body>


<div class="page">
<div class="card">
  <div class="checkwrap" aria-hidden="true">
    <div class="check">
      <svg viewBox="0 0 24 24">
        <path d="M20 6L9 17l-5-5"></path>
      </svg>
    </div>
  </div>

  <h2>Payment Successful</h2>
  <p id="message">Verifying your ticket...</p>

  <button class="btn" onclick="window.location.href='/'">Return Home</button>
  <div class="subnote">Powered by Stripe • Secure payment</div>
</div>

      <div class="scroll-hint">
  <span>Scroll down</span>
  <div class="chevrons">
    <div class="chevron"></div>
    <div class="chevron"></div>
    <div class="chevron"></div>
  </div>
</div>

<div class="how-to">
  <h3>How to claim your ticket in Backstage</h3>
  <ol>
    <li>Download the Backstage app</li>
    <li>From the Home Feed, tap the Ticket view</li>
    <li>Tap <strong>Claim Ticket</strong></li>
    <li>Enter your code and tap <strong>Submit</strong></li>
  </ol>
</div>

<div class="video-section">
<video
  id="redeemVideo"
  playsinline
  muted
  loop
  preload="metadata"
  style="width:100%; border-radius:24px;"
>
<source src="/assets/HowToClaim.mp4" type="video/mp4">
  </video>
</div>

  <script>

    const params = new URLSearchParams(window.location.search);
const sessionId = params.get("session_id");

if (!sessionId) {
  document.getElementById("message").innerText =
    "Missing session. Please check your email.";
} else {

      fetch("https://us-central1-backstageapp-27cb3.cloudfunctions.net/verifyCheckoutSession", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sessionId })
      })
      .then(res => res.json())
      .then(data => {

        console.log("VERIFY RESPONSE:", data);

        if (data.success && Array.isArray(data.codes) && data.codes.length > 0) {

const codesHtml = data.codes
  .map((code, index) => {
    const formatted = code.slice(0, 4) + " - " + code.slice(4);
    return `
      <div>
        <div class="codepill">${formatted}</div>
        <button class="copy-btn" onclick="copyCode('${code}', this)">
          Copy Code
        </button>
      </div>
    `;
  })
  .join("");

document.getElementById("message").innerHTML = `
  <p style="margin:8px 0 0; color: rgba(255,255,255,0.68); font-weight:600;">
    Use the code(s) below to redeem inside the Backstage app
  </p>

  <div class="codes">
    ${codesHtml}
  </div>

  <p style="margin:12px 0 0; color: rgba(255,255,255,0.68); font-weight:600;">
    We also emailed you your ticket code in case you forget
  </p>

  <p style="margin:16px 0 0; color: rgba(255,255,255,0.68); font-weight:600;">
    Download the Backstage app and enter your code to access your ticket
  </p>

  <a
    class="appstore"
    href="https://apps.apple.com/us/app/backstage-events/id6751863780"
    target="_blank"
    rel="noopener noreferrer"
  >
    <img
      src="/assets/app-store-badge.svg"
      alt="Download on the App Store"
      style="height:48px;"
    />
  </a>
`;

        } else {
       document.getElementById("message").innerText =
  "Finalizing your ticket… this may take a moment.";

setTimeout(() => {
  window.location.reload();
}, 1500);
        }

      })
      .catch(() => {
        document.getElementById("message").innerText =
          "Payment confirmed. Please check your email shortly.";
      });

    }

    const video = document.getElementById("redeemVideo");

if (video) {
  const observer = new IntersectionObserver(
    ([entry]) => {
      if (entry.isIntersecting) {
        video.play();
      }
    },
    { threshold: 0.6 }
  );

  observer.observe(video);
}
    function copyCode(rawCode, button){
  navigator.clipboard.writeText(rawCode)
    .then(() => {
      button.innerText = "Copied!";
      setTimeout(() => {
        button.innerText = "Copy Code";
      }, 1500);
    })
    .catch(() => {
      alert("Unable to copy. Please copy manually.");
    });
}
  </script>

</body>
</html>